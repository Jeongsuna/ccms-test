#---------------------------------------------------
# Base Jenkines Pipeline Script for Codemind v4.5.8
#---------------------------------------------------

name: Codemind CICD Base Script

on:
  workflow_dispatch:
    inputs:
      PROJECT_NAME:
        description: '프로젝트 식별자를 입력하세요.'
        required: true
      BRANCH_NAME:
        description: 'BRANCH NAME을 입력하세요.'
        required: false
      COMMIT_ID:
        description: '분석을 시작할 commit id를 입력하세요.'
        required: false

jobs:
  codemind-analysis:
    name: Run Codemind
    runs-on: self-hosted

    defaults:
      run:
        shell: bash

    env:
      CODEMIND_BASE_URL: "http://${{ secrets.CODEMIND_HOST }}"
      PROJECT_NAME: ${{ github.event.inputs.PROJECT_NAME }}
      BRANCH_NAME: ${{ github.event.inputs.BRANCH_NAME }}
      COMMIT_ID: ${{ github.event.inputs.COMMIT_ID }}

    steps:
      - name: 1. Login
        env:
          USERNAME: ${{ secrets.CODEMIND_USERNAME }}
          PASSWORD: ${{ secrets.CODEMIND_PASSWORD }}
        run: |
          echo "Attempting login to $CODEMIND_BASE_URL"
          
          # Jenkins의 'curl -c cookie'와 동일. 쿠키를 cookie.txt 파일에 저장
          loginRes=$(curl -c cookie.txt -o /dev/null -s -w "%{http_code}" \
            -d "username=$USERNAME&password=$PASSWORD&REQUEST_KIND=API" \
            "$CODEMIND_BASE_URL/user/login/process" -k)
          
          echo "Authentication response from Codemind server: $loginRes"
          
          # Jenkins의 'error'와 동일. 'exit 1'은 단계를 실패시킴
          if [ "$loginRes" != "200" ]; then
            echo "LOGIN_FAIL: Unable to authenticate with Codemind server."
            exit 1
          fi

      - name: 2. Check Valid Project
        run: |
          # 'curl -b cookie.txt'로 저장된 쿠키 파일을 사용
          validProjectRes=$(curl -b cookie.txt -H 'Accept:application/json' -o /dev/null -s -w "%{http_code}" \
            "$CODEMIND_BASE_URL/api/project/$PROJECT_NAME/info" -k)
          
          if [ "$validProjectRes" == "200" ]; then
            echo "Project($PROJECT_NAME) is valid"
          else
            # 원본 Jenkins 스크립트가 이 단계에서 실패 처리를 하지 않았으므로 동일하게 echo만 함
            echo "Project($PROJECT_NAME) not valid. HTTP Status: $validProjectRes"
          fi

      - name: 3. Code Analysis Request
        run: |
          # Jenkins의 Groovy 리스트 대신 Shell 변수로 쿼리 스트링 구성
          queryParams="checkDuplicatedAnalysis=false&checkoutMode=HEAD"
          
          # Jenkins의 if(COMMIT_ID) -> Shell의 if [ -n "$VAR" ]
          if [ -n "$COMMIT_ID" ]; then
            queryParams="$queryParams&revision=$COMMIT_ID"
          fi
          if [ -n "$BRANCH_NAME" ]; then
            queryParams="$queryParams&branch=$BRANCH_NAME"
          fi

          fullUrl="$CODEMIND_BASE_URL/api/analysis/$PROJECT_NAME?$queryParams"
          echo "Requesting analysis: $fullUrl"

          statusCode=$(curl -o /dev/null -s -w '%{http_code}' -b cookie.txt -X POST \
            "$fullUrl" -k)
          
          if [ "$statusCode" == "200" ]; then
            echo "Response from starting analysis project ($PROJECT_NAME) was successful."
          else
            echo "Failed to start analysis project ($PROJECT_NAME). Status code: $statusCode"
            exit 1
          fi
          
          echo "Sleeping 5 seconds..."
          sleep 5

      - name: 4. Monitor Analysis Progress
        timeout-minutes: 30
        run: |
          statusUrl="$CODEMIND_BASE_URL/api/project/$PROJECT_NAME/status"
          echo "Monitoring status at: $statusUrl"
          
          while true; do
            # Jenkins의 'try-catch'와 유사하게, curl -f로 HTTP 오류 시 스크립트가 멈추지 않게 처리
            # 또는 'set +e' / 'set -e'를 사용할 수 있지만, curl의 exit 코드를 확인하는 것이 더 명확함
            data=$(curl -b cookie.txt -H 'Accept:application/json' -s "$statusUrl" -k)
          
            if [ $? -ne 0 ]; then
               echo "Error fetching status (curl failed). Retrying in 5s..."
               sleep 5
               continue # 다음 루프 실행
            fi

            # 6. JSON 파싱 (Jenkins의 JsonSlurper -> GHA의 jq)
            # ubuntu-latest 러너에는 'jq'가 기본 설치되어 있음
            status=$(echo "$data" | jq -re '.status')
            sequence=$(echo "$data" | jq -re '.sequence')
          
            # 7. 단계 간 변수 전달 (Jenkins의 env.VAR = ... -> GHA의 $GITHUB_ENV)
            # 'SEQUENCE' 값을 다음 단계(Step)에서 사용할 수 있도록 GITHUB_ENV에 저장
            echo "SEQUENCE=$sequence" >> $GITHUB_ENV
          
            timestamp=$(date --iso-8601=seconds --utc)
            echo "[$timestamp] Received from Codemind, received status($status) ==="
          
            if [ "$status" == "success" ]; then
              echo "======================= Codemind project($PROJECT_NAME) analysis succeeded =================="
              break
            elif [ "$status" == "stop" ]; then
              echo "================ Codemind project($PROJECT_NAME) analysis stopped ==============="
              echo "Analysis Stopped for project $PROJECT_NAME"
              exit 1
            elif [ "$status" == "fail" ]; then
              echo "================ Codemind project($PROJECT_NAME) analysis failed ==============="
              echo "Analysis failed for project $PROJECT_NAME"
              exit 1
            elif [ "$status" == "reserved" ]; then
              echo "======================= Codemind project($PROJECT_NAME) reserved... =================="
            else
              echo "======================= Codemind project($PROJECT_NAME) analyzing... =================="
            fi
          
            sleep 5
          done

      - name: 5. Analysis Quality Results
        run: |
          # 7. $GITHUB_ENV로 설정된 변수는 $VAR 형태로 즉시 사용 가능
          echo "Checking quality results for sequence: $SEQUENCE"
          
          response=$(curl -f -b cookie.txt -H 'Accept:application/json' -s \
            "$CODEMIND_BASE_URL/api/project/$PROJECT_NAME/check-quality-result?sequence=$SEQUENCE" -k)
          
          if [ $? -ne 0 ]; then
             echo "Error fetching quality results (curl failed)."
             exit 1
          fi
          
          echo "Quality analysis results for project ($PROJECT_NAME): $response"
          
          # jq로 boolean 값 확인. (json.result != true)
          result=$(echo "$response" | jq -re '.result')
          
          if [ "$result" != "true" ]; then
            weaknessCount=$(echo "$response" | jq -re '.weaknessCount')
            echo "Code quality check failed (weakness detected: $weaknessCount)"
            exit 1
          else
            echo "Code quality check passed"
            # 'exit 1'이 없으면 성공(Success)으로 끝남
          fi